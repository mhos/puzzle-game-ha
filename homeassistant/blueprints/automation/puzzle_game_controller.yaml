blueprint:
  name: Puzzle Game Controller
  description: "Voice-controlled word puzzle game for View Assist. Say 'Start puzzle game', 'Play bonus game', or 'Continue puzzle game'. During gameplay, no wake word needed - just speak your answers, or say 'spell', 'reveal', 'skip', 'repeat', 'pause', or 'give up'."
  domain: automation
  author: mhos
  source_url: https://github.com/mhos/puzzle-game-ha/blob/main/homeassistant/blueprints/automation/puzzle_game_controller.yaml
  input: {}

mode: single

trigger:
  - platform: conversation
    command:
      - "start puzzle game"
      - "[start] [a] [new] puzzle [game]"
    id: start
  - platform: conversation
    command:
      - "play bonus game"
      - "[start] [a] bonus [puzzle] [game]"
      - "bonus round"
    id: bonus
  - platform: conversation
    command:
      - "continue puzzle game"
      - "resume puzzle game"
      - "continue [the] [puzzle] game"
    id: continue

variables:
  view_assist_device: "{{ view_assist_entity(trigger.device_id) }}"
  satellite_entity: "{{ trigger.satellite_id }}"

action:
  - choose:
      #############################################
      # START NEW GAME
      #############################################
      - conditions:
          - condition: trigger
            id: start
        sequence:
          - service: puzzle_game.start_game
            data:
              bonus: false
          - delay:
              seconds: 2
          - service: view_assist.set_state
            target:
              entity_id: "{{ view_assist_device }}"
            data:
              data:
                url: "/local/community/puzzle_game/dashboard.html"
                mode: hold
              title: "Puzzle Game"
          - service: view_assist.navigate
            data:
              device: "{{ view_assist_device }}"
              path: "/view-assist/webpage"
              revert_timeout: 0
          - service: view_assist.set_state
            target:
              entity_id: "{{ view_assist_device }}"
            data:
              assist_prompt: kitt_bar
          - delay:
              seconds: 1
          - service: assist_satellite.announce
            continue_on_error: true
            target:
              entity_id: "{{ satellite_entity }}"
            data:
              message: "{{ state_attr('sensor.puzzle_game', 'clue') }}"
              preannounce: false
          - delay:
              seconds: 1
          - service: assist_satellite.announce
            continue_on_error: true
            target:
              entity_id: "{{ satellite_entity }}"
            data:
              message: "What would you like to do? You can answer, spell, reveal, skip, repeat, or pause."
              preannounce: false

          # Start game loop inline
          - service: puzzle_game.set_session
            data:
              active: true
          - repeat:
              while:
                - condition: template
                  value_template: "{{ state_attr('sensor.puzzle_game', 'session_active') == true }}"
                - condition: template
                  value_template: "{{ state_attr('sensor.puzzle_game', 'is_active') == true }}"
              sequence:
                - variables:
                    player_action: null
                - action: assist_satellite.ask_question
                  continue_on_error: true
                  data:
                    question: ""
                    entity_id: "{{ satellite_entity }}"
                    preannounce: false
                    answers:
                      - id: reveal
                        sentences:
                          - "reveal"
                          - "reveal a letter"
                          - "show me a letter"
                          - "hint"
                      - id: skip
                        sentences:
                          - "skip"
                          - "pass"
                          - "next"
                          - "skip word"
                      - id: repeat
                        sentences:
                          - "repeat"
                          - "say that again"
                          - "what's the clue"
                          - "repeat clue"
                      - id: pause
                        sentences:
                          - "pause"
                          - "stop"
                          - "exit"
                          - "I'll be back"
                      - id: giveup
                        sentences:
                          - "give up"
                          - "I give up"
                          - "end game"
                      - id: spell
                        sentences:
                          - "spell"
                          - "spell it"
                          - "spell the word"
                          - "spell my answer"
                      - id: answer
                        sentences:
                          - "{answer}"
                          - "the answer is {answer}"
                          - "is it {answer}"
                  response_variable: player_action
                - choose:
                    # ANSWER
                    - conditions:
                        - condition: template
                          value_template: "{{ player_action.id == 'answer' }}"
                      sequence:
                        - service: puzzle_game.submit_answer
                          data:
                            answer: "{{ player_action.slots.answer }}"
                        - delay:
                            seconds: 1
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ state_attr('sensor.puzzle_game', 'last_message').startswith('Correct') }}"
                              sequence:
                                - service: assist_satellite.announce
                                  continue_on_error: true
                                  target:
                                    entity_id: "{{ satellite_entity }}"
                                  data:
                                    message: "{{ state_attr('sensor.puzzle_game', 'last_message') }}"
                                    preannounce: false
                          default:
                            - service: media_player.play_media
                              continue_on_error: true
                              target:
                                entity_id: "{{ satellite_entity | replace('assist_satellite.', 'media_player.') }}"
                              data:
                                media_content_id: "/local/community/puzzle_game/wrong.mp3"
                                media_content_type: "music"
                            - delay:
                                seconds: 1
                            - service: assist_satellite.announce
                              continue_on_error: true
                              target:
                                entity_id: "{{ satellite_entity }}"
                              data:
                                message: "{{ state_attr('sensor.puzzle_game', 'last_message') }}"
                                preannounce: false

                    # REVEAL
                    - conditions:
                        - condition: template
                          value_template: "{{ player_action.id == 'reveal' }}"
                      sequence:
                        - service: puzzle_game.reveal_letter
                        - delay:
                            seconds: 1
                        - service: assist_satellite.announce
                          continue_on_error: true
                          target:
                            entity_id: "{{ satellite_entity }}"
                          data:
                            message: "{{ state_attr('sensor.puzzle_game', 'last_message') }}"
                            preannounce: false

                    # SKIP
                    - conditions:
                        - condition: template
                          value_template: "{{ player_action.id == 'skip' }}"
                      sequence:
                        - service: puzzle_game.skip_word
                        - delay:
                            seconds: 1
                        - service: assist_satellite.announce
                          continue_on_error: true
                          target:
                            entity_id: "{{ satellite_entity }}"
                          data:
                            message: "{{ state_attr('sensor.puzzle_game', 'clue') }}"
                            preannounce: false

                    # REPEAT
                    - conditions:
                        - condition: template
                          value_template: "{{ player_action.id == 'repeat' }}"
                      sequence:
                        - service: puzzle_game.repeat_clue
                        - delay:
                            seconds: 1
                        - service: assist_satellite.announce
                          continue_on_error: true
                          target:
                            entity_id: "{{ satellite_entity }}"
                          data:
                            message: "{{ state_attr('sensor.puzzle_game', 'clue') }}"
                            preannounce: false

                    # PAUSE
                    - conditions:
                        - condition: template
                          value_template: "{{ player_action.id == 'pause' }}"
                      sequence:
                        - service: puzzle_game.set_session
                          data:
                            active: false
                        - service: assist_satellite.announce
                          continue_on_error: true
                          target:
                            entity_id: "{{ satellite_entity }}"
                          data:
                            message: "Paused. Say continue puzzle game to resume."
                            preannounce: false

                    # GIVE UP
                    - conditions:
                        - condition: template
                          value_template: "{{ player_action.id == 'giveup' }}"
                      sequence:
                        - service: puzzle_game.set_session
                          data:
                            active: false
                        - service: puzzle_game.give_up
                        - delay:
                            seconds: 2
                        - service: assist_satellite.announce
                          continue_on_error: true
                          target:
                            entity_id: "{{ satellite_entity }}"
                          data:
                            message: "{{ state_attr('sensor.puzzle_game', 'last_message') | default('Game ended.', true) }}"
                            preannounce: false

                    # SPELL MODE
                    - conditions:
                        - condition: template
                          value_template: "{{ player_action.id == 'spell' }}"
                      sequence:
                        - service: assist_satellite.announce
                          continue_on_error: true
                          target:
                            entity_id: "{{ satellite_entity }}"
                          data:
                            message: "Spell the word letter by letter. Say done when finished."
                            preannounce: false
                        - delay:
                            seconds: 1
                        - variables:
                            spelled_word: ""
                            spelling_active: true
                        - repeat:
                            while:
                              - condition: template
                                value_template: "{{ spelling_active }}"
                            sequence:
                              - variables:
                                  spell_input: null
                              - action: assist_satellite.ask_question
                                continue_on_error: true
                                data:
                                  question: ""
                                  entity_id: "{{ satellite_entity }}"
                                  preannounce: false
                                  answers:
                                    - id: done
                                      sentences:
                                        - "done"
                                        - "finished"
                                        - "submit"
                                        - "that's it"
                                    - id: letter
                                      sentences:
                                        - "{letter}"
                                response_variable: spell_input
                              - choose:
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ spell_input is defined and spell_input.id == 'done' }}"
                                    sequence:
                                      - variables:
                                          spelling_active: false
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ spell_input is defined and spell_input.id == 'letter' }}"
                                    sequence:
                                      - variables:
                                          spelled_word: "{{ spelled_word }}{{ spell_input.slots.letter | upper }}"
                                      - service: assist_satellite.announce
                                        continue_on_error: true
                                        target:
                                          entity_id: "{{ satellite_entity }}"
                                        data:
                                          message: "{{ spell_input.slots.letter | upper }}"
                                          preannounce: false
                                default:
                                  - variables:
                                      spelling_active: false
                                  - service: assist_satellite.announce
                                    continue_on_error: true
                                    target:
                                      entity_id: "{{ satellite_entity }}"
                                    data:
                                      message: "Spelling cancelled."
                                      preannounce: false
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ spelled_word | length > 0 }}"
                              sequence:
                                - service: assist_satellite.announce
                                  continue_on_error: true
                                  target:
                                    entity_id: "{{ satellite_entity }}"
                                  data:
                                    message: "{{ spelled_word }}"
                                    preannounce: false
                                - service: puzzle_game.submit_answer
                                  data:
                                    answer: "{{ spelled_word }}"
                                - delay:
                                    seconds: 1
                                - choose:
                                    - conditions:
                                        - condition: template
                                          value_template: "{{ state_attr('sensor.puzzle_game', 'last_message').startswith('Correct') }}"
                                      sequence:
                                        - service: assist_satellite.announce
                                          continue_on_error: true
                                          target:
                                            entity_id: "{{ satellite_entity }}"
                                          data:
                                            message: "{{ state_attr('sensor.puzzle_game', 'last_message') }}"
                                            preannounce: false
                                  default:
                                    - service: media_player.play_media
                                      continue_on_error: true
                                      target:
                                        entity_id: "{{ satellite_entity | replace('assist_satellite.', 'media_player.') }}"
                                      data:
                                        media_content_id: "/local/community/puzzle_game/wrong.mp3"
                                        media_content_type: "music"
                                    - delay:
                                        seconds: 1
                                    - service: assist_satellite.announce
                                      continue_on_error: true
                                      target:
                                        entity_id: "{{ satellite_entity }}"
                                      data:
                                        message: "{{ state_attr('sensor.puzzle_game', 'last_message') }}"
                                        preannounce: false

                  default: []

          - service: puzzle_game.set_session
            data:
              active: false

      #############################################
      # START BONUS GAME
      #############################################
      - conditions:
          - condition: trigger
            id: bonus
        sequence:
          - service: puzzle_game.start_game
            data:
              bonus: true
          - delay:
              seconds: 2
          - service: view_assist.set_state
            target:
              entity_id: "{{ view_assist_device }}"
            data:
              data:
                url: "/local/community/puzzle_game/dashboard.html"
                mode: hold
              title: "Puzzle Game"
          - service: view_assist.navigate
            data:
              device: "{{ view_assist_device }}"
              path: "/view-assist/webpage"
              revert_timeout: 0
          - service: view_assist.set_state
            target:
              entity_id: "{{ view_assist_device }}"
            data:
              assist_prompt: kitt_bar
          - delay:
              seconds: 1
          - service: assist_satellite.announce
            continue_on_error: true
            target:
              entity_id: "{{ satellite_entity }}"
            data:
              message: "{{ state_attr('sensor.puzzle_game', 'clue') }}"
              preannounce: false
          - delay:
              seconds: 1
          - service: assist_satellite.announce
            continue_on_error: true
            target:
              entity_id: "{{ satellite_entity }}"
            data:
              message: "What would you like to do? You can answer, spell, reveal, skip, repeat, or pause."
              preannounce: false

          # Start game loop inline (same as above)
          - service: puzzle_game.set_session
            data:
              active: true
          - repeat:
              while:
                - condition: template
                  value_template: "{{ state_attr('sensor.puzzle_game', 'session_active') == true }}"
                - condition: template
                  value_template: "{{ state_attr('sensor.puzzle_game', 'is_active') == true }}"
              sequence:
                - variables:
                    player_action: null
                - action: assist_satellite.ask_question
                  continue_on_error: true
                  data:
                    question: ""
                    entity_id: "{{ satellite_entity }}"
                    preannounce: false
                    answers:
                      - id: reveal
                        sentences:
                          - "reveal"
                          - "reveal a letter"
                          - "show me a letter"
                          - "hint"
                      - id: skip
                        sentences:
                          - "skip"
                          - "pass"
                          - "next"
                          - "skip word"
                      - id: repeat
                        sentences:
                          - "repeat"
                          - "say that again"
                          - "what's the clue"
                          - "repeat clue"
                      - id: pause
                        sentences:
                          - "pause"
                          - "stop"
                          - "exit"
                          - "I'll be back"
                      - id: giveup
                        sentences:
                          - "give up"
                          - "I give up"
                          - "end game"
                      - id: spell
                        sentences:
                          - "spell"
                          - "spell it"
                          - "spell the word"
                          - "spell my answer"
                      - id: answer
                        sentences:
                          - "{answer}"
                          - "the answer is {answer}"
                          - "is it {answer}"
                  response_variable: player_action
                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ player_action.id == 'answer' }}"
                      sequence:
                        - service: puzzle_game.submit_answer
                          data:
                            answer: "{{ player_action.slots.answer }}"
                        - delay:
                            seconds: 1
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ state_attr('sensor.puzzle_game', 'last_message').startswith('Correct') }}"
                              sequence:
                                - service: assist_satellite.announce
                                  continue_on_error: true
                                  target:
                                    entity_id: "{{ satellite_entity }}"
                                  data:
                                    message: "{{ state_attr('sensor.puzzle_game', 'last_message') }}"
                                    preannounce: false
                          default:
                            - service: media_player.play_media
                              continue_on_error: true
                              target:
                                entity_id: "{{ satellite_entity | replace('assist_satellite.', 'media_player.') }}"
                              data:
                                media_content_id: "/local/community/puzzle_game/wrong.mp3"
                                media_content_type: "music"
                            - delay:
                                seconds: 1
                            - service: assist_satellite.announce
                              continue_on_error: true
                              target:
                                entity_id: "{{ satellite_entity }}"
                              data:
                                message: "{{ state_attr('sensor.puzzle_game', 'last_message') }}"
                                preannounce: false
                    - conditions:
                        - condition: template
                          value_template: "{{ player_action.id == 'reveal' }}"
                      sequence:
                        - service: puzzle_game.reveal_letter
                        - delay:
                            seconds: 1
                        - service: assist_satellite.announce
                          continue_on_error: true
                          target:
                            entity_id: "{{ satellite_entity }}"
                          data:
                            message: "{{ state_attr('sensor.puzzle_game', 'last_message') }}"
                            preannounce: false
                    - conditions:
                        - condition: template
                          value_template: "{{ player_action.id == 'skip' }}"
                      sequence:
                        - service: puzzle_game.skip_word
                        - delay:
                            seconds: 1
                        - service: assist_satellite.announce
                          continue_on_error: true
                          target:
                            entity_id: "{{ satellite_entity }}"
                          data:
                            message: "{{ state_attr('sensor.puzzle_game', 'clue') }}"
                            preannounce: false
                    - conditions:
                        - condition: template
                          value_template: "{{ player_action.id == 'repeat' }}"
                      sequence:
                        - service: puzzle_game.repeat_clue
                        - delay:
                            seconds: 1
                        - service: assist_satellite.announce
                          continue_on_error: true
                          target:
                            entity_id: "{{ satellite_entity }}"
                          data:
                            message: "{{ state_attr('sensor.puzzle_game', 'clue') }}"
                            preannounce: false
                    - conditions:
                        - condition: template
                          value_template: "{{ player_action.id == 'pause' }}"
                      sequence:
                        - service: puzzle_game.set_session
                          data:
                            active: false
                        - service: assist_satellite.announce
                          continue_on_error: true
                          target:
                            entity_id: "{{ satellite_entity }}"
                          data:
                            message: "Paused. Say continue puzzle game to resume."
                            preannounce: false
                    - conditions:
                        - condition: template
                          value_template: "{{ player_action.id == 'giveup' }}"
                      sequence:
                        - service: puzzle_game.set_session
                          data:
                            active: false
                        - service: puzzle_game.give_up
                        - delay:
                            seconds: 2
                        - service: assist_satellite.announce
                          continue_on_error: true
                          target:
                            entity_id: "{{ satellite_entity }}"
                          data:
                            message: "{{ state_attr('sensor.puzzle_game', 'last_message') | default('Game ended.', true) }}"
                            preannounce: false
                    - conditions:
                        - condition: template
                          value_template: "{{ player_action.id == 'spell' }}"
                      sequence:
                        - service: assist_satellite.announce
                          continue_on_error: true
                          target:
                            entity_id: "{{ satellite_entity }}"
                          data:
                            message: "Spell the word letter by letter. Say done when finished."
                            preannounce: false
                        - delay:
                            seconds: 1
                        - variables:
                            spelled_word: ""
                            spelling_active: true
                        - repeat:
                            while:
                              - condition: template
                                value_template: "{{ spelling_active }}"
                            sequence:
                              - variables:
                                  spell_input: null
                              - action: assist_satellite.ask_question
                                continue_on_error: true
                                data:
                                  question: ""
                                  entity_id: "{{ satellite_entity }}"
                                  preannounce: false
                                  answers:
                                    - id: done
                                      sentences:
                                        - "done"
                                        - "finished"
                                        - "submit"
                                        - "that's it"
                                    - id: letter
                                      sentences:
                                        - "{letter}"
                                response_variable: spell_input
                              - choose:
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ spell_input is defined and spell_input.id == 'done' }}"
                                    sequence:
                                      - variables:
                                          spelling_active: false
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ spell_input is defined and spell_input.id == 'letter' }}"
                                    sequence:
                                      - variables:
                                          spelled_word: "{{ spelled_word }}{{ spell_input.slots.letter | upper }}"
                                      - service: assist_satellite.announce
                                        continue_on_error: true
                                        target:
                                          entity_id: "{{ satellite_entity }}"
                                        data:
                                          message: "{{ spell_input.slots.letter | upper }}"
                                          preannounce: false
                                default:
                                  - variables:
                                      spelling_active: false
                                  - service: assist_satellite.announce
                                    continue_on_error: true
                                    target:
                                      entity_id: "{{ satellite_entity }}"
                                    data:
                                      message: "Spelling cancelled."
                                      preannounce: false
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ spelled_word | length > 0 }}"
                              sequence:
                                - service: assist_satellite.announce
                                  continue_on_error: true
                                  target:
                                    entity_id: "{{ satellite_entity }}"
                                  data:
                                    message: "{{ spelled_word }}"
                                    preannounce: false
                                - service: puzzle_game.submit_answer
                                  data:
                                    answer: "{{ spelled_word }}"
                                - delay:
                                    seconds: 1
                                - choose:
                                    - conditions:
                                        - condition: template
                                          value_template: "{{ state_attr('sensor.puzzle_game', 'last_message').startswith('Correct') }}"
                                      sequence:
                                        - service: assist_satellite.announce
                                          continue_on_error: true
                                          target:
                                            entity_id: "{{ satellite_entity }}"
                                          data:
                                            message: "{{ state_attr('sensor.puzzle_game', 'last_message') }}"
                                            preannounce: false
                                  default:
                                    - service: media_player.play_media
                                      continue_on_error: true
                                      target:
                                        entity_id: "{{ satellite_entity | replace('assist_satellite.', 'media_player.') }}"
                                      data:
                                        media_content_id: "/local/community/puzzle_game/wrong.mp3"
                                        media_content_type: "music"
                                    - delay:
                                        seconds: 1
                                    - service: assist_satellite.announce
                                      continue_on_error: true
                                      target:
                                        entity_id: "{{ satellite_entity }}"
                                      data:
                                        message: "{{ state_attr('sensor.puzzle_game', 'last_message') }}"
                                        preannounce: false
                  default: []

          - service: puzzle_game.set_session
            data:
              active: false

      #############################################
      # CONTINUE/RESUME GAME
      #############################################
      - conditions:
          - condition: trigger
            id: continue
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ state_attr('sensor.puzzle_game', 'is_active') != true }}"
                sequence:
                  - service: assist_satellite.announce
                    continue_on_error: true
                    target:
                      entity_id: "{{ satellite_entity }}"
                    data:
                      message: "No active game found. Say start puzzle game to begin a new one."
                      preannounce: false
                  - stop: "No active game"
          - service: view_assist.set_state
            target:
              entity_id: "{{ view_assist_device }}"
            data:
              data:
                url: "/local/community/puzzle_game/dashboard.html"
                mode: hold
              title: "Puzzle Game"
          - service: view_assist.navigate
            data:
              device: "{{ view_assist_device }}"
              path: "/view-assist/webpage"
              revert_timeout: 0
          - service: view_assist.set_state
            target:
              entity_id: "{{ view_assist_device }}"
            data:
              assist_prompt: kitt_bar
          - service: assist_satellite.announce
            continue_on_error: true
            target:
              entity_id: "{{ satellite_entity }}"
            data:
              message: "Welcome back! {{ state_attr('sensor.puzzle_game', 'clue') }}"
              preannounce: false

          # Resume game loop inline (same as above)
          - service: puzzle_game.set_session
            data:
              active: true
          - repeat:
              while:
                - condition: template
                  value_template: "{{ state_attr('sensor.puzzle_game', 'session_active') == true }}"
                - condition: template
                  value_template: "{{ state_attr('sensor.puzzle_game', 'is_active') == true }}"
              sequence:
                - variables:
                    player_action: null
                - action: assist_satellite.ask_question
                  continue_on_error: true
                  data:
                    question: ""
                    entity_id: "{{ satellite_entity }}"
                    preannounce: false
                    answers:
                      - id: reveal
                        sentences:
                          - "reveal"
                          - "reveal a letter"
                          - "show me a letter"
                          - "hint"
                      - id: skip
                        sentences:
                          - "skip"
                          - "pass"
                          - "next"
                          - "skip word"
                      - id: repeat
                        sentences:
                          - "repeat"
                          - "say that again"
                          - "what's the clue"
                          - "repeat clue"
                      - id: pause
                        sentences:
                          - "pause"
                          - "stop"
                          - "exit"
                          - "I'll be back"
                      - id: giveup
                        sentences:
                          - "give up"
                          - "I give up"
                          - "end game"
                      - id: spell
                        sentences:
                          - "spell"
                          - "spell it"
                          - "spell the word"
                          - "spell my answer"
                      - id: answer
                        sentences:
                          - "{answer}"
                          - "the answer is {answer}"
                          - "is it {answer}"
                  response_variable: player_action
                - choose:
                    - conditions:
                        - condition: template
                          value_template: "{{ player_action.id == 'answer' }}"
                      sequence:
                        - service: puzzle_game.submit_answer
                          data:
                            answer: "{{ player_action.slots.answer }}"
                        - delay:
                            seconds: 1
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ state_attr('sensor.puzzle_game', 'last_message').startswith('Correct') }}"
                              sequence:
                                - service: assist_satellite.announce
                                  continue_on_error: true
                                  target:
                                    entity_id: "{{ satellite_entity }}"
                                  data:
                                    message: "{{ state_attr('sensor.puzzle_game', 'last_message') }}"
                                    preannounce: false
                          default:
                            - service: media_player.play_media
                              continue_on_error: true
                              target:
                                entity_id: "{{ satellite_entity | replace('assist_satellite.', 'media_player.') }}"
                              data:
                                media_content_id: "/local/community/puzzle_game/wrong.mp3"
                                media_content_type: "music"
                            - delay:
                                seconds: 1
                            - service: assist_satellite.announce
                              continue_on_error: true
                              target:
                                entity_id: "{{ satellite_entity }}"
                              data:
                                message: "{{ state_attr('sensor.puzzle_game', 'last_message') }}"
                                preannounce: false
                    - conditions:
                        - condition: template
                          value_template: "{{ player_action.id == 'reveal' }}"
                      sequence:
                        - service: puzzle_game.reveal_letter
                        - delay:
                            seconds: 1
                        - service: assist_satellite.announce
                          continue_on_error: true
                          target:
                            entity_id: "{{ satellite_entity }}"
                          data:
                            message: "{{ state_attr('sensor.puzzle_game', 'last_message') }}"
                            preannounce: false
                    - conditions:
                        - condition: template
                          value_template: "{{ player_action.id == 'skip' }}"
                      sequence:
                        - service: puzzle_game.skip_word
                        - delay:
                            seconds: 1
                        - service: assist_satellite.announce
                          continue_on_error: true
                          target:
                            entity_id: "{{ satellite_entity }}"
                          data:
                            message: "{{ state_attr('sensor.puzzle_game', 'clue') }}"
                            preannounce: false
                    - conditions:
                        - condition: template
                          value_template: "{{ player_action.id == 'repeat' }}"
                      sequence:
                        - service: puzzle_game.repeat_clue
                        - delay:
                            seconds: 1
                        - service: assist_satellite.announce
                          continue_on_error: true
                          target:
                            entity_id: "{{ satellite_entity }}"
                          data:
                            message: "{{ state_attr('sensor.puzzle_game', 'clue') }}"
                            preannounce: false
                    - conditions:
                        - condition: template
                          value_template: "{{ player_action.id == 'pause' }}"
                      sequence:
                        - service: puzzle_game.set_session
                          data:
                            active: false
                        - service: assist_satellite.announce
                          continue_on_error: true
                          target:
                            entity_id: "{{ satellite_entity }}"
                          data:
                            message: "Paused. Say continue puzzle game to resume."
                            preannounce: false
                    - conditions:
                        - condition: template
                          value_template: "{{ player_action.id == 'giveup' }}"
                      sequence:
                        - service: puzzle_game.set_session
                          data:
                            active: false
                        - service: puzzle_game.give_up
                        - delay:
                            seconds: 2
                        - service: assist_satellite.announce
                          continue_on_error: true
                          target:
                            entity_id: "{{ satellite_entity }}"
                          data:
                            message: "{{ state_attr('sensor.puzzle_game', 'last_message') | default('Game ended.', true) }}"
                            preannounce: false
                    - conditions:
                        - condition: template
                          value_template: "{{ player_action.id == 'spell' }}"
                      sequence:
                        - service: assist_satellite.announce
                          continue_on_error: true
                          target:
                            entity_id: "{{ satellite_entity }}"
                          data:
                            message: "Spell the word letter by letter. Say done when finished."
                            preannounce: false
                        - delay:
                            seconds: 1
                        - variables:
                            spelled_word: ""
                            spelling_active: true
                        - repeat:
                            while:
                              - condition: template
                                value_template: "{{ spelling_active }}"
                            sequence:
                              - variables:
                                  spell_input: null
                              - action: assist_satellite.ask_question
                                continue_on_error: true
                                data:
                                  question: ""
                                  entity_id: "{{ satellite_entity }}"
                                  preannounce: false
                                  answers:
                                    - id: done
                                      sentences:
                                        - "done"
                                        - "finished"
                                        - "submit"
                                        - "that's it"
                                    - id: letter
                                      sentences:
                                        - "{letter}"
                                response_variable: spell_input
                              - choose:
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ spell_input is defined and spell_input.id == 'done' }}"
                                    sequence:
                                      - variables:
                                          spelling_active: false
                                  - conditions:
                                      - condition: template
                                        value_template: "{{ spell_input is defined and spell_input.id == 'letter' }}"
                                    sequence:
                                      - variables:
                                          spelled_word: "{{ spelled_word }}{{ spell_input.slots.letter | upper }}"
                                      - service: assist_satellite.announce
                                        continue_on_error: true
                                        target:
                                          entity_id: "{{ satellite_entity }}"
                                        data:
                                          message: "{{ spell_input.slots.letter | upper }}"
                                          preannounce: false
                                default:
                                  - variables:
                                      spelling_active: false
                                  - service: assist_satellite.announce
                                    continue_on_error: true
                                    target:
                                      entity_id: "{{ satellite_entity }}"
                                    data:
                                      message: "Spelling cancelled."
                                      preannounce: false
                        - choose:
                            - conditions:
                                - condition: template
                                  value_template: "{{ spelled_word | length > 0 }}"
                              sequence:
                                - service: assist_satellite.announce
                                  continue_on_error: true
                                  target:
                                    entity_id: "{{ satellite_entity }}"
                                  data:
                                    message: "{{ spelled_word }}"
                                    preannounce: false
                                - service: puzzle_game.submit_answer
                                  data:
                                    answer: "{{ spelled_word }}"
                                - delay:
                                    seconds: 1
                                - choose:
                                    - conditions:
                                        - condition: template
                                          value_template: "{{ state_attr('sensor.puzzle_game', 'last_message').startswith('Correct') }}"
                                      sequence:
                                        - service: assist_satellite.announce
                                          continue_on_error: true
                                          target:
                                            entity_id: "{{ satellite_entity }}"
                                          data:
                                            message: "{{ state_attr('sensor.puzzle_game', 'last_message') }}"
                                            preannounce: false
                                  default:
                                    - service: media_player.play_media
                                      continue_on_error: true
                                      target:
                                        entity_id: "{{ satellite_entity | replace('assist_satellite.', 'media_player.') }}"
                                      data:
                                        media_content_id: "/local/community/puzzle_game/wrong.mp3"
                                        media_content_type: "music"
                                    - delay:
                                        seconds: 1
                                    - service: assist_satellite.announce
                                      continue_on_error: true
                                      target:
                                        entity_id: "{{ satellite_entity }}"
                                      data:
                                        message: "{{ state_attr('sensor.puzzle_game', 'last_message') }}"
                                        preannounce: false
                  default: []

          - service: puzzle_game.set_session
            data:
              active: false

# Puzzle Game Package for Home Assistant
# ============================================
# This file contains the script for continuous conversation during gameplay.
# The main game logic is handled by the puzzle_game integration.
#
# INSTALLATION:
# 1. Install the Puzzle Game integration via HACS
# 2. Copy this file to your Home Assistant config/packages/ folder
# 3. Add to configuration.yaml under homeassistant:
#      packages: !include_dir_named packages
# 4. Restart Home Assistant
# 5. Import the blueprint from GitHub
#
# ============================================

# Input helper for game session tracking
input_text:
  puzzle_game_session_active:
    name: Puzzle Game Session Active
    initial: ""
    max: 10

# ============================================
# SCRIPT - Active Game Loop
# Uses ask_question for continuous conversation (no wake word needed)
# ============================================

script:
  puzzle_game_active_session:
    alias: "Puzzle Game - Active Play Session"
    description: "Handles continuous conversation during active gameplay"
    fields:
      satellite_entity:
        description: "The assist satellite entity ID"
        example: "assist_satellite.my_device"
    sequence:
      # Mark session as active
      - service: input_text.set_value
        target:
          entity_id: input_text.puzzle_game_session_active
        data:
          value: "true"

      # Game loop - continues until user exits or game ends
      - repeat:
          while:
            - condition: template
              value_template: "{{ states('input_text.puzzle_game_session_active') == 'true' }}"
            - condition: template
              value_template: "{{ state_attr('sensor.puzzle_game', 'is_active') == true }}"
          sequence:
            # Clear previous response to detect new input
            - variables:
                player_action: null

            # Ask for user action (silent listening - no wake word needed)
            - action: assist_satellite.ask_question
              continue_on_error: true
              data:
                question: ""
                entity_id: "{{ satellite_entity }}"
                preannounce: false
                answers:
                  # Specific commands FIRST (before wildcard)
                  - id: reveal
                    sentences:
                      - "reveal"
                      - "reveal a letter"
                      - "show me a letter"
                      - "hint"
                  - id: skip
                    sentences:
                      - "skip"
                      - "pass"
                      - "next"
                      - "skip word"
                  - id: repeat
                    sentences:
                      - "repeat"
                      - "say that again"
                      - "what's the clue"
                      - "repeat clue"
                  - id: pause
                    sentences:
                      - "pause"
                      - "stop"
                      - "exit"
                      - "I'll be back"
                  - id: giveup
                    sentences:
                      - "give up"
                      - "I give up"
                      - "end game"
                  - id: spell
                    sentences:
                      - "spell"
                      - "spell it"
                      - "spell the word"
                      - "spell my answer"
                  # Wildcard answer LAST (catches everything else)
                  - id: answer
                    sentences:
                      - "{answer}"
                      - "the answer is {answer}"
                      - "is it {answer}"
              response_variable: player_action

            # Handle the action
            - choose:
                #############################################
                # ANSWER
                #############################################
                - conditions:
                    - condition: template
                      value_template: "{{ player_action.id == 'answer' }}"
                  sequence:
                    - service: puzzle_game.submit_answer
                      data:
                        answer: "{{ player_action.slots.answer }}"
                    - delay:
                        seconds: 1
                    - choose:
                        - conditions:
                            - condition: template
                              value_template: "{{ state_attr('sensor.puzzle_game', 'last_message').startswith('Correct') }}"
                          sequence:
                            - service: assist_satellite.announce
                              continue_on_error: true
                              target:
                                entity_id: "{{ satellite_entity }}"
                              data:
                                message: "{{ state_attr('sensor.puzzle_game', 'last_message') }}"
                                preannounce: false
                      default:
                        - service: media_player.play_media
                          continue_on_error: true
                          target:
                            entity_id: "{{ satellite_entity | replace('assist_satellite.', 'media_player.') }}"
                          data:
                            media_content_id: "/local/puzzle_game/wrong.mp3"
                            media_content_type: "music"
                        - delay:
                            seconds: 1
                        - service: assist_satellite.announce
                          continue_on_error: true
                          target:
                            entity_id: "{{ satellite_entity }}"
                          data:
                            message: "{{ state_attr('sensor.puzzle_game', 'last_message') }}"
                            preannounce: false

                #############################################
                # REVEAL
                #############################################
                - conditions:
                    - condition: template
                      value_template: "{{ player_action.id == 'reveal' }}"
                  sequence:
                    - service: puzzle_game.reveal_letter
                    - delay:
                        seconds: 1
                    - service: assist_satellite.announce
                      continue_on_error: true
                      target:
                        entity_id: "{{ satellite_entity }}"
                      data:
                        message: "{{ state_attr('sensor.puzzle_game', 'last_message') }}"
                        preannounce: false

                #############################################
                # SKIP
                #############################################
                - conditions:
                    - condition: template
                      value_template: "{{ player_action.id == 'skip' }}"
                  sequence:
                    - service: puzzle_game.skip_word
                    - delay:
                        seconds: 1
                    - service: assist_satellite.announce
                      continue_on_error: true
                      target:
                        entity_id: "{{ satellite_entity }}"
                      data:
                        message: "{{ state_attr('sensor.puzzle_game', 'clue') }}"
                        preannounce: false

                #############################################
                # REPEAT
                #############################################
                - conditions:
                    - condition: template
                      value_template: "{{ player_action.id == 'repeat' }}"
                  sequence:
                    - service: puzzle_game.repeat_clue
                    - delay:
                        seconds: 1
                    - service: assist_satellite.announce
                      continue_on_error: true
                      target:
                        entity_id: "{{ satellite_entity }}"
                      data:
                        message: "{{ state_attr('sensor.puzzle_game', 'clue') }}"
                        preannounce: false

                #############################################
                # PAUSE/EXIT
                #############################################
                - conditions:
                    - condition: template
                      value_template: "{{ player_action.id == 'pause' }}"
                  sequence:
                    - service: input_text.set_value
                      target:
                        entity_id: input_text.puzzle_game_session_active
                      data:
                        value: "false"
                    - service: assist_satellite.announce
                      continue_on_error: true
                      target:
                        entity_id: "{{ satellite_entity }}"
                      data:
                        message: "Paused. Say continue puzzle game to resume."
                        preannounce: false

                #############################################
                # GIVE UP
                #############################################
                - conditions:
                    - condition: template
                      value_template: "{{ player_action.id == 'giveup' }}"
                  sequence:
                    - service: input_text.set_value
                      target:
                        entity_id: input_text.puzzle_game_session_active
                      data:
                        value: "false"
                    - service: puzzle_game.give_up
                    - delay:
                        seconds: 2
                    - service: assist_satellite.announce
                      continue_on_error: true
                      target:
                        entity_id: "{{ satellite_entity }}"
                      data:
                        message: "{{ state_attr('sensor.puzzle_game', 'last_message') | default('Game ended.', true) }}"
                        preannounce: false

                #############################################
                # SPELL MODE
                #############################################
                - conditions:
                    - condition: template
                      value_template: "{{ player_action.id == 'spell' }}"
                  sequence:
                    - service: assist_satellite.announce
                      continue_on_error: true
                      target:
                        entity_id: "{{ satellite_entity }}"
                      data:
                        message: "Spell the word letter by letter. Say done when finished."
                        preannounce: false
                    - delay:
                        seconds: 1

                    # Initialize spelled word
                    - variables:
                        spelled_word: ""
                        spelling_active: true

                    # Spelling loop
                    - repeat:
                        while:
                          - condition: template
                            value_template: "{{ spelling_active }}"
                        sequence:
                          - variables:
                              spell_input: null

                          - action: assist_satellite.ask_question
                            continue_on_error: true
                            data:
                              question: ""
                              entity_id: "{{ satellite_entity }}"
                              preannounce: false
                              answers:
                                - id: done
                                  sentences:
                                    - "done"
                                    - "finished"
                                    - "submit"
                                    - "that's it"
                                - id: letter
                                  sentences:
                                    - "{letter}"
                            response_variable: spell_input

                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: "{{ spell_input is defined and spell_input.id == 'done' }}"
                                sequence:
                                  - variables:
                                      spelling_active: false
                              - conditions:
                                  - condition: template
                                    value_template: "{{ spell_input is defined and spell_input.id == 'letter' }}"
                                sequence:
                                  - variables:
                                      spelled_word: "{{ spelled_word }}{{ spell_input.slots.letter | upper }}"
                                  - service: assist_satellite.announce
                                    continue_on_error: true
                                    target:
                                      entity_id: "{{ satellite_entity }}"
                                    data:
                                      message: "{{ spell_input.slots.letter | upper }}"
                                      preannounce: false
                            default:
                              - variables:
                                  spelling_active: false
                              - service: assist_satellite.announce
                                continue_on_error: true
                                target:
                                  entity_id: "{{ satellite_entity }}"
                                data:
                                  message: "Spelling cancelled."
                                  preannounce: false

                    # Submit the spelled word
                    - choose:
                        - conditions:
                            - condition: template
                              value_template: "{{ spelled_word | length > 0 }}"
                          sequence:
                            - service: assist_satellite.announce
                              continue_on_error: true
                              target:
                                entity_id: "{{ satellite_entity }}"
                              data:
                                message: "{{ spelled_word }}"
                                preannounce: false
                            - service: puzzle_game.submit_answer
                              data:
                                answer: "{{ spelled_word }}"
                            - delay:
                                seconds: 1
                            - choose:
                                - conditions:
                                    - condition: template
                                      value_template: "{{ state_attr('sensor.puzzle_game', 'last_message').startswith('Correct') }}"
                                  sequence:
                                    - service: assist_satellite.announce
                                      continue_on_error: true
                                      target:
                                        entity_id: "{{ satellite_entity }}"
                                      data:
                                        message: "{{ state_attr('sensor.puzzle_game', 'last_message') }}"
                                        preannounce: false
                              default:
                                - service: media_player.play_media
                                  continue_on_error: true
                                  target:
                                    entity_id: "{{ satellite_entity | replace('assist_satellite.', 'media_player.') }}"
                                  data:
                                    media_content_id: "/local/puzzle_game/wrong.mp3"
                                    media_content_type: "music"
                                - delay:
                                    seconds: 1
                                - service: assist_satellite.announce
                                  continue_on_error: true
                                  target:
                                    entity_id: "{{ satellite_entity }}"
                                  data:
                                    message: "{{ state_attr('sensor.puzzle_game', 'last_message') }}"
                                    preannounce: false

              # Timeout or unrecognized - continue loop silently
              default: []

      # Mark session as inactive when loop exits
      - service: input_text.set_value
        target:
          entity_id: input_text.puzzle_game_session_active
        data:
          value: "false"
